<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The World of Draelon – Campaign Primer (v31 – Zoom Bounds & Island Size)</title>
  <style>
    /* ------------------------------------------------------------
       Fantasy / Parchment Theme
    ------------------------------------------------------------ */
    :root{
      --bg:#efe7d2;
      --paper:#fbf3dd;
      --paper-2:#f6edd1;
      --ink:#2c2416;
      --ink-soft:#5c523f;
      --accent:#8b5e34;      /* bronze ink */
      --accent-2:#3a5a40;    /* deep green */
      --rule:#d8caa6;
      --edge:#cbb98f;
      --shadow:0 18px 40px rgba(0,0,0,.25);
      --radius:16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 60% 0%, #f9f1d9 0%, #efe7d2 60%, #e7dbbd 100%);
      font-family: Georgia, "Iowan Old Style", "Palatino Linotype", serif;
      line-height:1.4;
    }
    body:before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background:
        radial-gradient(800px 400px at 40% -10%, rgba(139,94,52,.07), transparent 60%),
        radial-gradient(600px 600px at 90% 0%, rgba(58,90,64,.08), transparent 70%),
        repeating-linear-gradient(0deg, rgba(0,0,0,.03), rgba(0,0,0,.03) 1px, transparent 2px, transparent 4px);
      mix-blend-mode:multiply; opacity:.6;
    }
    .primer, .panel{
      background: linear-gradient(180deg, var(--paper), var(--paper-2));
      border: 1px solid var(--edge);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:relative;
    }
    .primer::after, .panel::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      border-radius: var(--radius);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.04), inset 0 30px 60px rgba(0,0,0,.06);
    }

    .primer{margin:16px; padding:18px 18px 14px}
    .primer h2{
      margin:0 0 10px 0; font-size:26px; letter-spacing:.5px;
      text-transform:uppercase; font-weight:700;
      border-bottom:2px solid var(--rule); padding-bottom:6px;
    }

    .app{display:grid;grid-template-columns:1fr minmax(320px,440px);gap:16px}
    .map-wrap{position:relative;min-height:58vh;max-height:74vh;margin:16px;overflow:hidden}
    .map-wrap svg{width:100%;height:100%;display:block;background:#efe6c8;touch-action:none}

    .muted{color:var(--ink-soft);font-size:12px}

    /* Loader and GM button */
    .loader{position:absolute;left:10px;top:10px;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.75);border:1px solid var(--edge);border-radius:10px;padding:6px 10px;z-index:20;backdrop-filter:blur(2px)}
    .spinner{width:14px;height:14px;border-radius:50%;border:2px solid rgba(0,0,0,.2); border-top-color:var(--accent); animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .gm-btn{position:absolute;top:12px;right:12px;z-index:10;background:linear-gradient(180deg, #f7edcf, #efe2b6);color:var(--ink);border:1px solid var(--edge);border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer;box-shadow: var(--shadow)}
    .gm-btn:hover{filter:brightness(1.02)}

    /* GM modal + CMS */
    .gm-modal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:20}
    .gm-modal.open{display:flex}
    .gm-modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25);backdrop-filter:blur(2px)}
    .gm-modal-card{position:relative;width:min(92%,380px);background:var(--paper-2);border:1px solid var(--edge);border-radius:14px;box-shadow:var(--shadow);padding:16px;z-index:1}
    .gm-modal-card h3{margin:0 0 8px;font-size:18px}
    .gm-modal-card input{width:100%;background:#fff8e7;color:var(--ink);border:1px solid var(--edge);border-radius:10px;padding:10px 12px;box-sizing:border-box;margin:8px 0 10px}
    .btn{background:#fff6d8;color:var(--ink);border:1px solid var(--edge);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:#c9a66b;color:#1e1406;font-weight:800;border:0}

    .cms{position:absolute;top:56px;right:12px;width:min(620px,calc(100% - 24px));max-height:calc(100% - 68px);background:var(--paper-2);border:1px solid var(--edge);border-radius:14px;box-shadow:var(--shadow);display:none;z-index:9;overflow:hidden}
    .cms.open{display:flex;flex-direction:column}
    .cms header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--rule);flex-wrap:wrap}
    .cms header h2{font-size:16px;margin:0}
    .cms .cms-body{padding:12px;overflow:auto;display:grid;gap:10px}
    .row{display:grid;gap:6px}
    .row label{font-size:12px;color:var(--ink-soft)}
    .row input[type="text"],.row textarea,.row select,.row input[type="color"]{width:100%;box-sizing:border-box;background:#fff6d8;color:var(--ink);border:1px solid var(--edge);border-radius:10px;padding:10px 12px}
    .row textarea{min-height:100px;resize:vertical}
    .list{border-top:1px dashed var(--rule);padding-top:8px;display:grid;gap:6px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;background:#f5ecd0;border:1px solid var(--edge);border-radius:10px}

    /* Sidebar */
    .side{display:flex;flex-direction:column;min-height:58vh;max-height:74vh;margin:16px 16px 16px 0;overflow:hidden}
    .side header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--rule);background:linear-gradient(180deg,var(--paper),var(--paper-2));border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}
    .side header h1{font-size:18px;margin:0;letter-spacing:.6px;text-transform:uppercase}
    .side .content{padding:16px;overflow:auto}
    .lore-title{font-weight:700;margin:0 0 8px;font-size:20px;letter-spacing:.2px}
    .lore-body{line-height:1.6;white-space:pre-wrap}

    /* Map features */
    .feature{cursor:pointer}
    .feature.point circle{stroke:var(--paper);stroke-width:3;fill:var(--accent)}
    .feature.point .label{font-size:36px;fill:var(--ink);pointer-events:none;paint-order:stroke;stroke:#faedcf;stroke-width:6px;stroke-linejoin:round}
    .feature.region path{stroke-width:0;transition:fill-opacity .12s linear}
    .feature.region.hover path{fill-opacity:.35}
    .feature.region.selected path{fill-opacity:.42}

    /* Tooltip */
    .tooltip{position:absolute;min-width:260px;max-width:380px;background:var(--paper);border:1px solid var(--edge);border-radius:12px;box-shadow: var(--shadow);z-index:15;display:none;pointer-events:auto;overflow:hidden}
    .tooltip.open{display:block}
    .tooltip header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--rule)}
    .tooltip header h3{margin:0;font-size:16px}
    .tooltip .close{background:transparent;border:0;color:var(--ink);cursor:pointer;font-size:18px}
    .tooltip .media{width:100%;max-height:180px;overflow:hidden;background:#e6d9b6;border-bottom:1px solid var(--rule)}
    .tooltip .media img{width:100%;height:auto;display:block}
    .tooltip .body{padding:10px 12px;line-height:1.5}
    .tooltip .body p{margin:0}

    /* Island Section (image-only, capped size) */
    .section{margin:8px 16px 16px 16px}
    .section header{display:flex;align-items:center;justify-content:space-between;margin:0 0 8px 0}
    .section h2{margin:0;font-size:22px;text-transform:uppercase;letter-spacing:.6px}
    .island-grid{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:start}
    .island-card{
      margin:0; padding:12px;
      background:linear-gradient(180deg, var(--paper), var(--paper-2));
      border:1px solid var(--edge); border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:inline-block;
      max-width:min(50vw, 1024px); /* <= Half page at most */
    }
    .island-card img{display:block; width:100%; height:auto}
    .island-lore{padding:16px}
    .island-lore h3{margin:0 0 8px 0;font-size:18px;text-transform:uppercase;letter-spacing:.4px}
    .island-lore .body{white-space:pre-wrap; line-height:1.6}

    @media (max-width: 900px){
      .app{grid-template-columns:1fr}
      .side{grid-row:2;margin:0 16px 16px 16px}
      .map-wrap{margin:0 16px}
      .island-grid{grid-template-columns:1fr}
      .island-card{justify-self:center; max-width:min(90vw, 1024px)}
    }
  </style>
</head>
<body>
  <div class="primer" id="primerTop">
    <h2>The World of Draelon</h2>
    <div id="primerIntro">This is your editable campaign introduction. Enable GM mode to edit this text. Players can scroll the map, tap regions, and read tooltips.</div>
  </div>

  <div class="app">
    <div class="map-wrap panel" id="mapWrap">
      <!-- Loader -->
      <div class="loader" id="loader" aria-live="polite"><div class="spinner"></div><span id="loaderText">Loading world…</span></div>

      <!-- GM Mode -->
      <button class="gm-btn" id="gmBtn" title="GM Mode" type="button">GM</button>
      <div class="gm-modal" id="gmModal" aria-hidden="true">
        <div class="gm-modal-backdrop" id="gmBackdrop"></div>
        <div class="gm-modal-card">
          <h3>Enter GM Passcode</h3>
          <input id="gmPass" type="password" placeholder="Passcode" autocomplete="off" />
          <div class="toolbar" style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn" id="gmCancel" type="button">Cancel</button>
            <button class="btn primary" id="gmSubmit" type="button">Unlock</button>
          </div>
          <p class="muted" id="gmError" style="display:none;margin-top:8px;color:#8b2b2b">Wrong code. Try again.</p>
        </div>
      </div>

      <div class="cms" id="cms">
        <header>
          <h2>GM Tools</h2>
          <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="toolExport" type="button">Export</button>
            <label class="btn" for="importFile" style="cursor:pointer;">Import</label>
            <input id="importFile" type="file" accept="application/json" style="display:none;" />
          </div>
        </header>
        <div class="cms-body">
          <div class="row">
            <label>Primer Intro (top) – auto-saves</label>
            <textarea id="primerIntroEdit" placeholder="Edit the top primer text..."></textarea>
          </div>
          <div class="row">
            <label>Primer Details (bottom) – auto-saves</label>
            <textarea id="primerDetailsEdit" placeholder="Edit the bottom primer details..."></textarea>
          </div>
          <div class="row">
            <label>Island Lore (auto-saves)</label>
            <textarea id="islandLoreEdit" placeholder="Describe Signika's history, factions, landmarks..."></textarea>
          </div>
          <div class="row">
            <label>Selected Feature</label>
            <select id="featurePicker"></select>
          </div>
          <div class="row">
            <label for="featName">Name (auto-saves)</label>
            <input id="featName" type="text" placeholder="e.g., Signika" />
          </div>
          <div class="row">
            <label for="featDesc">Lore / Notes (auto-saves)</label>
            <textarea id="featDesc" placeholder="Write lore or notes..."></textarea>
          </div>
          <div class="row" id="rowColor" style="display:none;">
            <label for="featColor">Region Colour (live)</label>
            <input id="featColor" type="color" value="#8ad9ff" />
          </div>
          <div class="row" id="rowImagePath">
            <label for="featImagePath">Region Image URL/Path (optional)</label>
            <input id="featImagePath" type="text" placeholder="map/oscana.jpg" />
          </div>
        </div>
      </div>

      <!-- Tooltip -->
      <div class="tooltip" id="tooltip" role="dialog" aria-live="polite">
        <div class="media" id="ttMedia" style="display:none"><img id="ttImg" alt=""></div>
        <header>
          <h3 id="ttTitle">Title</h3>
          <button class="close" id="ttClose" aria-label="Close">×</button>
        </header>
        <div class="body" id="ttBody"><p>Description…</p></div>
      </div>

      <!-- World Map (interactive) -->
      <svg id="world" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet" aria-label="Interactive world map">
        <defs>
          <filter id="fuzzyEdge" x="-4%" y="-4%" width="108%" height="108%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="2.5" result="blur" />
            <feComposite in="SourceGraphic" in2="blur" operator="in" />
          </filter>
        </defs>
        <image id="mapImage" href="" x="0" y="0" width="1000" height="600" preserveAspectRatio="none" />
        <g id="regions"></g>
        <g id="points"></g>
      </svg>
    </div>

    <aside class="side panel" id="sidePanel">
      <header>
        <h1>Campaign Info</h1>
        <span class="muted">Click the map to explore</span>
      </header>
      <div class="content">
        <h3 class="lore-title" id="loreTitle">Welcome</h3>
        <div class="lore-body" id="loreBody">Use the map to learn about regions like <b>Oscana</b>, <b>Athium</b>, <b>Eturia</b>, and the island of <b>Signika</b>. On mobile, tap points; on desktop, click to open details.</div>
      </div>
    </aside>
  </div>

  <!-- Island Panel (image at natural size alongside island lore, max half page) -->
  <section class="section">
    <header>
      <h2>Signika — Island Primer</h2>
      <span class="muted">Reference map & lore</span>
    </header>
    <div class="island-grid">
      <figure class="island-card">
        <img id="islandImg" src="" alt="Signika island map"/>
      </figure>
      <div class="island-lore panel">
        <h3>Island Lore</h3>
        <div id="islandLore" class="body">Add your Signika lore here — history, factions, features, and travel notes.</div>
      </div>
    </div>
  </section>

  <div class="primer panel" id="primerBottom">
    <h2>Primer – Details</h2>
    <div id="primerDetails">Add your campaign factions, tone, safety tools, character hooks, and session 0 notes here. Enable GM mode to edit this section.</div>
  </div>

<script>
(function(){
  // ---- Config -------------------------------------------------------------
  const JSON_PATH = './world-data.json';
  const DEFAULT_WORLD_MAP = './map/world-map.png';
  const DEFAULT_ISLAND_MAP = './map/campaign-map.png';
  const STORAGE_KEY = 'signika.world.v31';

  // ---- State --------------------------------------------------------------
  let state = null;
  let gmOpen = false;

  // ---- Elements -----------------------------------------------------------
  const svgWorld   = document.getElementById('world');
  const mapImage   = document.getElementById('mapImage');
  const gRegions   = document.getElementById('regions');
  const gPoints    = document.getElementById('points');
  const mapWrap    = document.getElementById('mapWrap');

  const islandImg  = document.getElementById('islandImg');
  const islandLore = document.getElementById('islandLore');

  const loader     = document.getElementById('loader');
  const primerIntro = document.getElementById('primerIntro');
  const primerDetails = document.getElementById('primerDetails');
  const loreTitle  = document.getElementById('loreTitle');
  const loreBody   = document.getElementById('loreBody');

  // CMS bits
  const gmBtn = document.getElementById('gmBtn');
  const gmModal = document.getElementById('gmModal');
  const gmBackdrop = document.getElementById('gmBackdrop');
  const gmPass = document.getElementById('gmPass');
  const gmSubmit = document.getElementById('gmSubmit');
  const gmCancel = document.getElementById('gmCancel');
  const gmError = document.getElementById('gmError');
  const cms = document.getElementById('cms');

  const primerIntroEdit = document.getElementById('primerIntroEdit');
  const primerDetailsEdit = document.getElementById('primerDetailsEdit');
  const islandLoreEdit = document.getElementById('islandLoreEdit');

  const featurePicker = document.getElementById('featurePicker');
  const featName = document.getElementById('featName');
  const featDesc = document.getElementById('featDesc');
  const featColor = document.getElementById('featColor');
  const rowColor = document.getElementById('rowColor');
  const featImagePath = document.getElementById('featImagePath');
  const importFile = document.getElementById('importFile');
  const exportBtn = document.getElementById('toolExport');

  // Tooltip
  const tooltip = document.getElementById('tooltip');
  const ttTitle = document.getElementById('ttTitle');
  const ttBody  = document.getElementById('ttBody');
  const ttMedia = document.getElementById('ttMedia');
  const ttImg   = document.getElementById('ttImg');
  const ttClose = document.getElementById('ttClose');

  // ---- Utility ------------------------------------------------------------
  const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));
  const escapeHTML = (s)=> (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function loadLocal(){
    try{ const raw = localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw): null; }catch(e){ return null; }
  }
  function saveLocal(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
  }

  function roundedPolygonPath(points, r){
    if(!points || points.length<2) return '';
    const n = points.length;
    let d = '';
    for(let i=0;i<n;i++){
      const p0 = points[(i-1+n)%n], p1 = points[i], p2 = points[(i+1)%n];
      const v1x = p1.x - p0.x, v1y = p1.y - p0.y;
      const v2x = p2.x - p1.x, v2y = p2.y - p1.y;
      const l1 = Math.hypot(v1x, v1y), l2 = Math.hypot(v2x, v2y);
      const r1 = Math.min(r, l1/3), r2 = Math.min(r, l2/3);
      const pA = {x: p1.x - v1x/l1*r1, y: p1.y - v1y/l1*r1};
      const pB = {x: p1.x + v2x/l2*r2, y: p1.y + v2y/l2*r2};
      if(i===0){ d += `M ${pA.x} ${pA.y} `; } else { d += `L ${pA.x} ${pA.y} `; }
      d += `Q ${p1.x} ${p1.y} ${pB.x} ${pB.y} `;
    }
    d += 'Z';
    return d;
  }

  // ---- Bounded Navigator for World ---------------------------------------
  function makeBoundedNavigator(svgEl, imgW, imgH){
    // Start at full image
    svgEl.setAttribute('viewBox', `0 0 ${imgW} ${imgH}`);
    const state = {viewBox:[0,0,imgW,imgH], minW: imgW, minH: imgH, maxZoomFactor: 0.08, panning:false, last:{x:0,y:0}};
    function apply(){ svgEl.setAttribute('viewBox', state.viewBox.join(' ')); }
    function clampView(){
      // clamp size (can't be larger than full image == zoomed out beyond full)
      let [x,y,w,h] = state.viewBox;
      w = Math.max(Math.min(w, imgW), imgW*state.maxZoomFactor);
      h = Math.max(Math.min(h, imgH), imgH*state.maxZoomFactor);
      // keep inside bounds
      x = clamp(x, 0, imgW - w);
      y = clamp(y, 0, imgH - h);
      state.viewBox = [x,y,w,h];
    }
    svgEl.addEventListener('wheel', (e)=>{
      e.preventDefault();
      let [vx,vy,vw,vh] = state.viewBox;
      const scale = (e.deltaY<0? 0.9: 1.1);
      // zoom around cursor
      const mx = e.offsetX / svgEl.clientWidth;
      const my = e.offsetY / svgEl.clientHeight;
      let nw = vw * scale;
      let nh = vh * scale;
      // bounds for zoom
      nw = clamp(nw, imgW*state.maxZoomFactor, imgW);
      nh = clamp(nh, imgH*state.maxZoomFactor, imgH);
      const nx = clamp(vx + (vw - nw)*mx, 0, imgW - nw);
      const ny = clamp(vy + (vh - nh)*my, 0, imgH - nh);
      state.viewBox = [nx,ny,nw,nh];
      apply();
    }, {passive:false});
    svgEl.addEventListener('pointerdown', (e)=>{ state.panning=true; state.last={x:e.clientX,y:e.clientY}; svgEl.setPointerCapture(e.pointerId); });
    svgEl.addEventListener('pointermove', (e)=>{
      if(!state.panning) return;
      let [vx,vy,vw,vh] = state.viewBox;
      const dx = (e.clientX - state.last.x) * (vw/svgEl.clientWidth);
      const dy = (e.clientY - state.last.y) * (vh/svgEl.clientHeight);
      vx = clamp(vx - dx, 0, Math.max(0, imgW - vw));
      vy = clamp(vy - dy, 0, Math.max(0, imgH - vh));
      state.viewBox = [vx,vy,vw,vh]; state.last={x:e.clientX,y:e.clientY}; apply();
    });
    svgEl.addEventListener('pointerup', ()=> state.panning=false);
    // public
    return {
      reset: ()=>{ state.viewBox=[0,0,imgW,imgH]; apply(); },
      resize: ()=>{ /* keep current view but ensure clamps */ clampView(); apply(); }
    };
  }

  // ---- Init ---------------------------------------------------------------
  let navWorld = null;

  init().catch(console.error);

  async function init(){
    showLoader(true);
    const data = await loadData();
    state = migrate(data) || {};

    // text
    primerIntro.textContent = state.primerIntro || '';
    primerDetails.textContent = state.primerDetails || '';
    islandLore.textContent = state.islandLore || islandLore.textContent;

    // world map: fixed to exact image coords (no infinite zoom out)
    const wSize = state.mapSize || {w:4080,h:3072};
    mapImage.setAttribute('href', state.mapSrc || DEFAULT_WORLD_MAP);
    mapImage.setAttribute('width', wSize.w); mapImage.setAttribute('height', wSize.h);
    // Important: map image uses preserveAspectRatio='none' and we keep SVG viewBox == image dimensions
    svgWorld.setAttribute('viewBox', `0 0 ${wSize.w} ${wSize.h}`);

    // island image
    islandImg.src = state.campaignMapSrc || state.campaignMap || DEFAULT_ISLAND_MAP;
    islandImg.alt = "Signika island map";

    // render world features
    renderFeatures();

    // bounded navigator
    navWorld = makeBoundedNavigator(svgWorld, wSize.w, wSize.h);

    // GM
    gmBtn.addEventListener('click', ()=> gmModal.classList.add('open'));
    gmBackdrop.addEventListener('click', ()=> gmModal.classList.remove('open'));
    gmCancel.addEventListener('click', ()=> gmModal.classList.remove('open'));
    gmSubmit.addEventListener('click', ()=>{
      const pass = (gmPass.value||'').trim();
      if(pass === (state.gmPass||'signika')){
        gmOpen = true; gmModal.classList.remove('open'); cms.classList.add('open'); gmError.style.display='none';
        bindCMS();
      }else{
        gmError.style.display='block';
      }
    });

    // Tooltip close
    ttClose.addEventListener('click', ()=> tooltip.classList.remove('open'));

    // On resize, we don't change viewBox scale; still bounded by image
    window.addEventListener('resize', ()=> navWorld.resize());

    showLoader(false);
  }

  async function loadData(){
    try{
      const res = await fetch(JSON_PATH, {cache:'no-store'});
      if(!res.ok) throw new Error('json not found');
      const data = await res.json();
      return {
        mapSrc: data.mapImage || data.mapSrc || DEFAULT_WORLD_MAP,
        mapSize: data.mapSize || {w:4080,h:3072},
        campaignMapSrc: data.campaignMap || data.campaignMapSrc || DEFAULT_ISLAND_MAP,
        campaignMapSize: data.campaignMapSize || {w:1024,h:1024},
        features: data.features || [],
        primerIntro: data.primerIntro || '',
        primerDetails: data.primerDetails || '',
        islandLore: data.islandLore || ''
      };
    }catch(e){
      const loc = loadLocal();
      if(loc) return loc;
      return {
        mapSrc: DEFAULT_WORLD_MAP,
        mapSize: {w:4080,h:3072},
        campaignMapSrc: DEFAULT_ISLAND_MAP,
        campaignMapSize: {w:1024,h:1024},
        features: [], primerIntro:'', primerDetails:'', islandLore:''
      };
    }
  }

  function migrate(s){
    s = s || {};
    if(!s.campaignMapSrc && s.campaignMap) s.campaignMapSrc = s.campaignMap;
    if(typeof s.islandLore !== 'string') s.islandLore = '';
    return s;
  }

  function renderFeatures(){
    gRegions.innerHTML=''; gPoints.innerHTML='';
    const feats = (state.features||[]);
    // Regions
    feats.filter(f=>f.type==='region').forEach(f=>{
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.classList.add('feature','region'); g.dataset.id = f.id||uid();
      const color = f.color || '#8ad9ff';
      (f.shapes||[]).forEach(shape=>{
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', roundedPolygonPath(shape, 10));
        path.setAttribute('fill', color);
        path.setAttribute('fill-opacity', '0.31');
        path.setAttribute('stroke','none');
        path.style.filter = 'url(#fuzzyEdge)';
        path.addEventListener('click', (e)=> showTooltipFor(f, e));
        g.appendChild(path);
      });
      g.addEventListener('mouseenter', ()=> g.classList.add('hover'));
      g.addEventListener('mouseleave', ()=> g.classList.remove('hover'));
      gRegions.appendChild(g);
    });
    // Points
    feats.filter(f=>f.type==='point').forEach(f=>{
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.classList.add('feature','point'); g.dataset.id = f.id||uid();
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx', f.x); c.setAttribute('cy', f.y); c.setAttribute('r', 18);
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', f.x + 30); label.setAttribute('y', f.y - 30); label.classList.add('label'); label.textContent = f.name || '';
      c.addEventListener('click', (e)=> showTooltipFor(f, e));
      label.addEventListener('click', (e)=> showTooltipFor(f, e));
      g.appendChild(c); g.appendChild(label); gPoints.appendChild(g);
    });
  }

  function showTooltipFor(f, evt){
    if(!f) return;
    ttTitle.textContent = f.name || '—';
    ttBody.innerHTML = '<p>' + escapeHTML(f.desc || '') + '</p>';
    const src = f.img || f.image || f.imageUrl || null;
    if(src){ ttImg.src = src; ttImg.alt = f.name? (f.name+' image'): 'Feature image'; ttMedia.style.display='block'; }
    else { ttImg.removeAttribute('src'); ttMedia.style.display='none'; }
    tooltip.classList.add('open');
    positionTooltip(evt);
    loreTitle.textContent = f.name || 'Details';
    loreBody.textContent = f.desc || '';
  }

  function positionTooltip(evt){
    const mapWrapRect = mapWrap.getBoundingClientRect();
    const ttRect = tooltip.getBoundingClientRect();
    const x = clamp(evt.clientX - mapWrapRect.left + 12, 8, mapWrapRect.width - ttRect.width - 8);
    const y = clamp(evt.clientY - mapWrapRect.top + 12, 8, mapWrapRect.height - ttRect.height - 8);
    tooltip.style.left = x + 'px';
    tooltip.style.top  = y + 'px';
  }

  function bindCMS(){
    const feats = state.features || [];
    featurePicker.innerHTML = '';
    feats.forEach((f,idx)=>{
      const opt = document.createElement('option');
      opt.value = f.id || (f.id = uid());
      opt.textContent = `${f.type.toUpperCase()} – ${f.name || 'Untitled'}`;
      featurePicker.appendChild(opt);
    });
    featurePicker.onchange = ()=> selectFeature(featurePicker.value);
    if(feats.length) { featurePicker.value = feats[0].id; selectFeature(feats[0].id); }

    primerIntroEdit.value = state.primerIntro || '';
    primerDetailsEdit.value = state.primerDetails || '';
    islandLoreEdit.value = state.islandLore || '';

    primerIntroEdit.oninput = ()=>{ state.primerIntro = primerIntroEdit.value; primerIntro.textContent = state.primerIntro; saveLocal(); }
    primerDetailsEdit.oninput = ()=>{ state.primerDetails = primerDetailsEdit.value; primerDetails.textContent = state.primerDetails; saveLocal(); }
    islandLoreEdit.oninput = ()=>{ state.islandLore = islandLoreEdit.value; islandLore.textContent = state.islandLore; saveLocal(); }

    exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'world-data.json'; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 3000);
    };
    importFile.onchange = async ()=>{
      const file = importFile.files[0]; if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        Object.assign(state, migrate({
          mapSrc: data.mapImage || data.mapSrc || state.mapSrc,
          mapSize: data.mapSize || state.mapSize,
          campaignMapSrc: data.campaignMap || data.campaignMapSrc || state.campaignMapSrc,
          campaignMapSize: data.campaignMapSize || state.campaignMapSize,
          features: data.features || state.features,
          primerIntro: data.primerIntro ?? state.primerIntro,
          primerDetails: data.primerDetails ?? state.primerDetails,
          islandLore: data.islandLore ?? state.islandLore
        }));
        saveLocal();
        location.reload();
      }catch(e){ alert('Invalid JSON'); }
    };
  }

  function selectFeature(id){
    const f = (state.features||[]).find(x=>x.id===id);
    if(!f) return;
    featName.value = f.name || '';
    featDesc.value = f.desc || '';
    featImagePath.value = f.img || f.image || '';
    if(f.type === 'region'){ rowColor.style.display='block'; featColor.value = f.color || '#8ad9ff'; }
    else { rowColor.style.display='none'; }
    featName.oninput = ()=>{ f.name = featName.value; renderFeatures(); saveLocal(); };
    featDesc.oninput = ()=>{ f.desc = featDesc.value; renderFeatures(); saveLocal(); };
    featImagePath.oninput = ()=>{ f.img = featImagePath.value; renderFeatures(); saveLocal(); };
    featColor.oninput = ()=>{ if(f.type==='region'){ f.color = featColor.value; renderFeatures(); saveLocal(); } };
  }

  function showLoader(on){ loader.style.display = on? 'flex': 'none'; }
})();
</script>
</body>
</html>
