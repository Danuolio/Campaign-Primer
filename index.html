<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The World of Draelon – Campaign Primer (v36)</title>
  <style>
    :root{
      --bg:#efe7d2; --paper:#fbf3dd; --paper-2:#f6edd1; --ink:#2c2416; --ink-soft:#5c523f;
      --accent:#8b5e34; --rule:#d8caa6; --edge:#cbb98f; --shadow:0 18px 40px rgba(0,0,0,.25); --radius:16px;
      --wrap:895px;
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background: radial-gradient(1200px 800px at 60% 0%, #f9f1d9 0%, #efe7d2 60%, #e7dbbd 100%);
      font-family: Georgia, "Iowan Old Style", "Palatino Linotype", serif; line-height:1.4;
    }
    body:before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background:
        radial-gradient(800px 400px at 40% -10%, rgba(139,94,52,.07), transparent 60%),
        radial-gradient(600px 600px at 90% 0%, rgba(58,90,64,.08), transparent 70%),
        repeating-linear-gradient(0deg, rgba(0,0,0,.03), rgba(0,0,0,.03) 1px, transparent 2px, transparent 4px);
      mix-blend-mode:multiply; opacity:.6;
    }
    .primer,.panel{
      background: linear-gradient(180deg, var(--paper), var(--paper-2));
      border: 1px solid var(--edge);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:relative;
    }
    .primer::after,.panel::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      border-radius: var(--radius);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.04), inset 0 30px 60px rgba(0,0,0,.06);
    }

    .primer{margin:16px; padding:18px 18px 14px}
    .primer h2{
      margin:0 0 10px 0; font-size:26px; letter-spacing:.5px;
      text-transform:uppercase; font-weight:700;
      border-bottom:2px solid var(--rule); padding-bottom:6px;
    }

    /* Single-column layout: world map row, then side panel row */
    .app{
      display:grid;
      grid-template-columns: 1fr;
      gap:0;
    }

    /* World map wrap centered, capped width */
    .map-row{display:flex; justify-content:center}
    .map-wrap{
      position:relative;
      width:100%;
      max-width:var(--wrap);
      min-height:58vh;
      max-height:74vh;
      margin:16px; /* keeps panel spacing */
      overflow:hidden;
    }
    .map-wrap svg{
      width:100%;
      height:100%;
      display:block;
      background:#efe6c8;
      touch-action:none;
      cursor:grab;
    }

    /* Side panel below world map, same width for rhythm */
    .side-row{display:flex; justify-content:center}
    .side{
      width:100%;
      max-width:var(--wrap);
      display:flex;flex-direction:column;
      min-height:unset; max-height:none;
      margin:0 16px 16px 16px; overflow:hidden;
    }
    .side header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--rule);background:linear-gradient(180deg,var(--paper),var(--paper-2));border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}
    .side header h1{font-size:18px;margin:0;letter-spacing:.6px;text-transform:uppercase}
    .side .content{padding:16px;overflow:visible}
    .lore-title{font-weight:700;margin:0 0 8px;font-size:20px;letter-spacing:.2px}
    .lore-body{line-height:1.6;white-space:pre-wrap}

    .muted{color:var(--ink-soft);font-size:12px}

    .loader{position:absolute;left:10px;top:10px;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.75);border:1px solid var(--edge);border-radius:10px;padding:6px 10px;z-index:20;backdrop-filter:blur(2px)}
    .spinner{width:14px;height:14px;border-radius:50%;border:2px solid rgba(0,0,0,.2); border-top-color:var(--accent); animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .gm-btn{position:absolute;top:12px;right:12px;z-index:10;background:linear-gradient(180deg, #f7edcf, #efe2b6);color:var(--ink);border:1px solid var(--edge);border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer;box-shadow: var(--shadow)}

    /* Feature styling */
    .feature{cursor:pointer}
    .feature.point circle{stroke:var(--paper);stroke-width:3;fill:var(--accent)}
    .feature.point .label{font-size:36px;fill:var(--ink);pointer-events:none;paint-order:stroke;stroke:#faedcf;stroke-width:6px;stroke-linejoin:round}
    .feature.region path{stroke-width:0;transition:fill-opacity .12s linear; pointer-events:auto}
    .feature.region.hover path{fill-opacity:.35}
    .feature.region.selected path{fill-opacity:.42}

    /* Tooltip */
    .tooltip{position:absolute;min-width:260px;max-width:380px;background:var(--paper);border:1px solid var(--edge);border-radius:12px;box-shadow: var(--shadow);z-index:1000;display:none;pointer-events:auto;overflow:hidden}
    .tooltip.open{display:block}
    .tooltip header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--rule)}
    .tooltip header h3{margin:0;font-size:16px}
    .tooltip .close{background:transparent;border:0;color:var(--ink);cursor:pointer;font-size:18px}
    .tooltip .media{width:100%;max-height:180px;overflow:hidden;background:#e6d9b6;border-bottom:1px solid var(--rule)}
    .tooltip .media img{width:100%;height:auto;display:block}
    .tooltip .body{padding:10px 12px;line-height:1.5}
    .tooltip .body p{margin:0}

    /* Island Section (campaign map area) */
    .section{margin:8px 16px 16px 16px}
    .island-grid{
      display:grid;
      grid-template-columns:auto 1fr;
      gap:16px;
      align-items:start;
      /* no global centering here; keep natural flow */
      max-width: 1280px;
      margin: 0 16px;
    }
    .island-card{
      margin:0; padding:12px;
      background:linear-gradient(180deg, var(--paper), var(--paper-2));
      border:1px solid var(--edge); border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:inline-block;
      max-width:min(50vw, 1024px);
    }
    .island-card img{display:block; width:100%; height:auto}
    .island-lore{padding:16px}
    .island-lore h3{margin:0 0 8px 0;font-size:18px;text-transform:uppercase;letter-spacing:.4px}
    .island-lore .body{white-space:pre-wrap; line-height:1.6}

    @media (max-width: 900px){
      .island-grid{grid-template-columns:1fr}
      .island-card{max-width:min(90vw, 1024px)}
    }
  </style>
</head>
<body>
  <div class="primer" id="primerTop">
    <h2>The World of Draelon</h2>
    <div id="primerIntro">This is your editable campaign introduction. Enable GM mode to edit this text. Players can scroll the map, tap regions, and read tooltips.</div>
  </div>

  <div class="app">
    <div class="map-row">
      <div class="map-wrap panel" id="mapWrap">
        <div class="loader" id="loader" aria-live="polite"><div class="spinner"></div><span id="loaderText">Loading world…</span></div>
        <button class="gm-btn" id="gmBtn" title="GM Mode" type="button">GM</button>

        <div class="tooltip" id="tooltip" role="dialog" aria-live="polite">
          <div class="media" id="ttMedia" style="display:none"><img id="ttImg" alt=""></div>
          <header>
            <h3 id="ttTitle">Title</h3>
            <button class="close" id="ttClose" aria-label="Close">×</button>
          </header>
          <div class="body" id="ttBody"><p>Description…</p></div>
        </div>

        <svg id="world" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet" aria-label="Interactive world map">
          <defs>
            <filter id="fuzzyEdge" x="-4%" y="-4%" width="108%" height="108%">
              <feGaussianBlur in="SourceAlpha" stdDeviation="2.5" result="blur" />
              <feComposite in="SourceGraphic" in2="blur" operator="in" />
            </filter>
          </defs>
          <image id="mapImage" href="" x="0" y="0" width="1000" height="600" preserveAspectRatio="none" />
          <g id="regions"></g>
          <g id="points"></g>
        </svg>
      </div>
    </div>

    <div class="side-row">
      <aside class="side panel" id="sidePanel">
        <header><h1>Campaign Info</h1><span class="muted">Click the map to explore</span></header>
        <div class="content">
          <h3 class="lore-title" id="loreTitle">Welcome</h3>
          <div class="lore-body" id="loreBody">Use the map to learn about regions like <b>Oscana</b>, <b>Athium</b>, <b>Eturia</b>, and the island of <b>Signika</b>.</div>
        </div>
      </aside>
    </div>
  </div>

  <section class="section">
    <div class="island-grid">
      <figure class="island-card"><img id="islandImg" src="" alt="Signika island map"/></figure>
      <div class="island-lore panel"><h3>Island Lore</h3><div id="islandLore" class="body">Add your Signika lore here — history, factions, features, and travel notes.</div></div>
    </div>
  </section>

  <div class="primer panel" id="primerBottom">
    <h2>Primer – Details</h2>
    <div id="primerDetails">Add your campaign factions, tone, safety tools, character hooks, and session 0 notes here. Enable GM mode to edit this section.</div>
  </div>

<script>
(function(){
  const JSON_PATH = './world-data.json';
  const DEFAULT_WORLD_MAP = '/Campaign-Primer/map/world-map.png';
  const DEFAULT_ISLAND_MAP = '/Campaign-Primer/map/campaign-map.png';
  const STORAGE_KEY = 'signika.world.v36';

  let state=null;

  const mapWrap  = document.getElementById('mapWrap');
  const svgWorld = document.getElementById('world');
  const mapImage = document.getElementById('mapImage');
  const gRegions = document.getElementById('regions');
  const gPoints  = document.getElementById('points');
  const islandImg = document.getElementById('islandImg');
  const islandLore = document.getElementById('islandLore');
  const primerIntro = document.getElementById('primerIntro');
  const primerDetails = document.getElementById('primerDetails');
  const loreTitle = document.getElementById('loreTitle');
  const loreBody  = document.getElementById('loreBody');
  const loader = document.getElementById('loader');
  const tooltip = document.getElementById('tooltip');
  const ttTitle = document.getElementById('ttTitle');
  const ttBody  = document.getElementById('ttBody');
  const ttMedia = document.getElementById('ttMedia');
  const ttImg   = document.getElementById('ttImg');
  const ttClose = document.getElementById('ttClose');

  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const elNS=(n)=>document.createElementNS('http://www.w3.org/2000/svg',n);
  const escapeHTML = s => (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function roundedPolygonPath(points, r){
    if(!points || points.length<2) return '';
    const n=points.length; let d='';
    for(let i=0;i<n;i++){
      const p0=points[(i-1+n)%n], p1=points[i], p2=points[(i+1)%n];
      const v1x=p1.x-p0.x, v1y=p1.y-p0.y, v2x=p2.x-p1.x, v2y=p2.y-p1.y;
      const l1=Math.hypot(v1x,v1y), l2=Math.hypot(v2x,v2y);
      const r1=Math.min(r, l1/3), r2=Math.min(r, l2/3);
      const A={x:p1.x - v1x/l1*r1, y:p1.y - v1y/l1*r1};
      const B={x:p1.x + v2x/l2*r2, y:p1.y + v2y/l2*r2};
      if(i===0) d+=`M ${A.x} ${A.y} `; else d+=`L ${A.x} ${A.y} `;
      d+=`Q ${p1.x} ${p1.y} ${B.x} ${B.y} `;
    }
    return d+'Z';
  }

  function makeBoundedNavigator(svgEl, imgW, imgH){
    svgEl.setAttribute('viewBox', `0 0 ${imgW} ${imgH}`);
    const nav={viewBox:[0,0,imgW,imgH], maxZoomFactor:0.08,
               panning:false, dragCandidate:false, dragged:false, start:{x:0,y:0}, last:{x:0,y:0}};
    const apply=()=> svgEl.setAttribute('viewBox', nav.viewBox.join(' '));

    svgEl.addEventListener('wheel', (e)=>{
      let [vx,vy,vw,vh]=nav.viewBox;
      const atFull = (vw >= imgW - 0.5 && vh >= imgH - 0.5);
      // Allow page scroll when fully zoomed out and scrolling down
      if(atFull && e.deltaY > 0){ return; } // no preventDefault -> page scrolls
      e.preventDefault();
      const scale=(e.deltaY<0?0.9:1.1);
      const mx=e.offsetX/svgEl.clientWidth, my=e.offsetY/svgEl.clientHeight;
      let nw=clamp(vw*scale, imgW*nav.maxZoomFactor, imgW);
      let nh=clamp(vh*scale, imgH*nav.maxZoomFactor, imgH);
      const nx=clamp(vx+(vw-nw)*mx, 0, imgW-nw);
      const ny=clamp(vy+(vh-nh)*my, 0, imgH-nh);
      nav.viewBox=[nx,ny,nw,nh]; apply();
    }, {passive:false});

    // Helper to suppress click after a drag, once
    function suppressNextClick(){
      const blocker = (ev)=>{ ev.stopPropagation(); ev.preventDefault(); window.removeEventListener('click', blocker, true); };
      window.addEventListener('click', blocker, true);
    }

    svgEl.addEventListener('pointerdown', (e)=>{
      // We allow starting on features; decide later if it becomes a drag
      nav.dragCandidate = true; nav.dragged = false;
      nav.start = {x:e.clientX, y:e.clientY};
      nav.last  = {x:e.clientX, y:e.clientY};
      svgEl.style.cursor='grabbing';
    });

    svgEl.addEventListener('pointermove', (e)=>{
      if(!nav.dragCandidate && !nav.panning) return;
      const dx0 = e.clientX - nav.start.x;
      const dy0 = e.clientY - nav.start.y;
      const dist2 = dx0*dx0 + dy0*dy0;
      const threshold2 = 16; // ~4px movement threshold
      if(nav.dragCandidate && dist2 > threshold2){
        // Activate panning
        nav.panning = true; nav.dragCandidate = false; nav.dragged = true;
        try{ svgEl.setPointerCapture(e.pointerId); }catch{}
        e.preventDefault(); // avoid not-allowed cursor and selection
      }
      if(!nav.panning) return;
      let [vx,vy,vw,vh]=nav.viewBox;
      const dx=(e.clientX-nav.last.x)*(vw/svgEl.clientWidth);
      const dy=(e.clientY-nav.last.y)*(vh/svgEl.clientHeight);
      vx=clamp(vx-dx,0,Math.max(0,imgW-vw));
      vy=clamp(vy-dy,0,Math.max(0,imgH-vh));
      nav.viewBox=[vx,vy,vw,vh]; nav.last={x:e.clientX,y:e.clientY}; apply();
    });

    function endPan(e){
      if(nav.panning){ suppressNextClick(); }
      nav.panning=false; nav.dragCandidate=false; nav.dragged=false; svgEl.style.cursor='grab';
      try{ svgEl.releasePointerCapture(e.pointerId); }catch{}
    }
    svgEl.addEventListener('pointerup', endPan);
    svgEl.addEventListener('pointercancel', endPan);

    return { reset:()=>{ nav.viewBox=[0,0,imgW,imgH]; apply(); } };
  }

  init().catch(console.error);

  async function init(){
    const data = await loadData();
    state = data || {};
    primerIntro.textContent = state.primerIntro || '';
    primerDetails.textContent = state.primerDetails || '';
    islandLore.textContent = state.islandLore || islandLore.textContent;

    const wSize = state.mapSize || {w:4080,h:3072};
    mapImage.setAttribute('href', state.mapSrc || DEFAULT_WORLD_MAP);
    mapImage.setAttribute('width', wSize.w); mapImage.setAttribute('height', wSize.h);
    svgWorld.setAttribute('viewBox', `0 0 ${wSize.w} ${wSize.h}`);

    islandImg.src = state.campaignMapSrc || state.campaignMap || DEFAULT_ISLAND_MAP;
    islandImg.alt = "Signika island map";

    renderFeatures();
    makeBoundedNavigator(svgWorld, wSize.w, wSize.h);

    ttClose.addEventListener('click', ()=> tooltip.classList.remove('open'));
    loader.style.display='none';
  }

  async function loadData(){
    try{
      const res = await fetch(JSON_PATH, {cache:'no-store'});
      if(!res.ok) throw 0;
      const data = await res.json();
      return {
        mapSrc: data.mapImage || data.mapSrc || DEFAULT_WORLD_MAP,
        mapSize: data.mapSize || {w:4080,h:3072},
        campaignMapSrc: data.campaignMap || data.campaignMapSrc || DEFAULT_ISLAND_MAP,
        campaignMapSize: data.campaignMapSize || {w:1024,h:1024},
        features: data.features || [],
        primerIntro: data.primerIntro || '',
        primerDetails: data.primerDetails || '',
        islandLore: data.islandLore || ''
      };
    }catch(e){
      return { mapSrc: DEFAULT_WORLD_MAP, mapSize:{w:4080,h:3072}, campaignMapSrc: DEFAULT_ISLAND_MAP,
               campaignMapSize:{w:1024,h:1024}, features:[], primerIntro:'', primerDetails:'', islandLore:'' };
    }
  }

  function renderFeatures(){
    gRegions.innerHTML=''; gPoints.innerHTML='';
    const feats = (state.features||[]);

    // Regions
    feats.filter(f=>f.type==='region').forEach(f=>{
      const g=elNS('g'); g.classList.add('feature','region'); g.dataset.id=f.id||'';
      const color=f.color||'#8ad9ff';
      (f.shapes||[]).forEach(shape=>{
        const p=elNS('path');
        p.setAttribute('d', roundedPolygonPath(shape, 10));
        p.setAttribute('fill', color);
        p.setAttribute('fill-opacity', '0.31');
        p.setAttribute('stroke','none');
        p.style.filter='url(#fuzzyEdge)';
        p.addEventListener('click', (e)=> showTooltipFor(f, e));
        g.appendChild(p);
      });
      g.addEventListener('click', (e)=> showTooltipFor(f,e));
      g.addEventListener('mouseenter', ()=> g.classList.add('hover'));
      g.addEventListener('mouseleave', ()=> g.classList.remove('hover'));
      gRegions.appendChild(g);
    });

    // Points
    feats.filter(f=>f.type==='point').forEach(f=>{
      const g=elNS('g'); g.classList.add('feature','point'); g.dataset.id=f.id||'';
      const c=elNS('circle'); c.setAttribute('cx', f.x); c.setAttribute('cy', f.y); c.setAttribute('r', 18);
      const t=elNS('text'); t.setAttribute('x', f.x+30); t.setAttribute('y', f.y-30); t.classList.add('label'); t.textContent=f.name||'';
      const open=(e)=> showTooltipFor(f,e);
      c.addEventListener('click', open); t.addEventListener('click', open);
      g.appendChild(c); g.appendChild(t); gPoints.appendChild(g);
    });
  }

  function showTooltipFor(f, evt){
    if(!f) return;
    ttTitle.textContent = f.name || '—';
    ttBody.innerHTML = '<p>' + (f.desc? escapeHTML(f.desc) : '—') + '</p>';
    const src = f.img || f.image || f.imageUrl || null;
    if(src){ ttImg.src = src; ttImg.alt = f.name? (f.name+' image'): 'Feature image'; ttMedia.style.display='block'; }
    else { ttImg.removeAttribute('src'); ttMedia.style.display='none'; }
    tooltip.classList.add('open'); positionTooltip(evt);
    loreTitle.textContent = f.name || 'Details';
    loreBody.textContent = f.desc || '';
  }

  function positionTooltip(evt){
    const wrapRect = mapWrap.getBoundingClientRect();
    const ttRect = tooltip.getBoundingClientRect();
    const cx = (evt && evt.clientX) || (wrapRect.left + wrapRect.width/2);
    const cy = (evt && evt.clientY) || (wrapRect.top + wrapRect.height/2);
    let x = cx - wrapRect.left + 12;
    let y = cy - wrapRect.top + 12;
    const maxX = wrapRect.width - ttRect.width - 8;
    const maxY = wrapRect.height - ttRect.height - 8;
    x = Math.max(8, Math.min(maxX, x)); y = Math.max(8, Math.min(maxY, y));
    tooltip.style.left = x + 'px'; tooltip.style.top = y + 'px';
  }

})();
</script>
</body>
</html>
